@page "/projetos"
@using BlazorDeploy.Models
@using BlazorDeploy.Services
@inject IPortfolioService PortfolioService
@inject ModalService ModService
@inject IJSRuntime JSRuntime

@inherits ComponentBase


<section id="projetos" class="section">
<h2>🗂️ Projetos</h2>

@if (ProjectsByCategory == null)
{
    <div class="d-flex justify-content-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <ul class="nav nav-tabs" id="projectTabs" role="tablist">
        @foreach (var categoria in ProjectsByCategory.Keys)
        {
            <li class="nav-item" role="presentation">
                <button class="nav-link @(categoriaAtiva == categoria ? "active" : "")"
                        @onclick="() => SetActiveCategory(categoria)"
                        type="button" role="tab">
                    @categoria
                </button>
            </li>
        }
    </ul>

    <div class="tab-content mt-3" id="projectTabsContent">
        @foreach (var categoria in ProjectsByCategory.Keys)
        {
            <div class="tab-pane fade @(categoriaAtiva == categoria ? "show active" : "")" role="tabpanel">

                <div id="carousel-@categoria.Replace(" ", "-")" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        @foreach (var projeto in ProjectsByCategory[categoria])
                        {
                            <div class="carousel-item @(ProjectsByCategory[categoria].IndexOf(projeto) == 0 ? "active" : "")">
                                <div class="project-card mx-auto">
                                    <h5 title="@projeto.Name">@projeto.Name</h5>
                                    <p title="@projeto.Synopsis">@projeto.Synopsis</p>

                                    <button class="btn btn-primary" @onclick="() => ModService.Show(projeto)">Saiba mais</button>
                                </div>
                                <div class="py-2 text-center">
                                    <span class="text-black">@(ProjectsByCategory[categoria].IndexOf(projeto) + 1)/@ProjectsByCategory[categoria].Count</span>
                                </div>
                            </div>
                        }
                    </div>

                    @if (ProjectsByCategory[categoria].Count > 1)
                    {
                        <button class="carousel-control-prev" type="button" data-bs-target="#carousel-@categoria.Replace(" ", "-")" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon bg-dark rounded-circle p-3" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carousel-@categoria.Replace(" ", "-")" data-bs-slide="next">
                            <span class="carousel-control-next-icon bg-dark rounded-circle p-3" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    }
                </div>
            </div>
        }
    </div>
}

</section>

@code {
    private List<PortfolioProject> Projetos;
    private List<ProjectCategory> Categories;

    private Dictionary<string, List<PortfolioProject>> ProjectsByCategory;

    private string categoriaAtiva;

    protected override async Task OnInitializedAsync()
    {
        var categoriesTask = PortfolioService.GetCategoriesAsync();
        var projectsTask = PortfolioService.GetProjectsAsync();

        await Task.WhenAll(categoriesTask, projectsTask);

        Categories = await categoriesTask;
        Projetos = await projectsTask;

        GroupProjectsByCategory();

        if (ProjectsByCategory.Any())
        {
            categoriaAtiva = ProjectsByCategory.Keys.First();
        }
    }

    private void GroupProjectsByCategory()
    {
        ProjectsByCategory = new Dictionary<string, List<PortfolioProject>>();

        foreach (var cat in Categories)
        {
            var projectsInCat = Projetos.Where(p => p.CategoryId == cat.Id).ToList();

            if (projectsInCat.Any())
            {
                ProjectsByCategory.Add(cat.Name, projectsInCat);
            }
        }
    }

    private void SetActiveCategory(string categoryName)
    {
        categoriaAtiva = categoryName;
    }
}

<style>
    .project-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
    }

    .project-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #f9f9f9;
        border-radius: 8px;
        padding: 20px;
        width: 100%;
        max-width: 700px;
        height: 250px;
        text-align: start;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
    }

        .project-card h5 {
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 10px;
        }

        .project-card p {
            width: 100%;
            height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 10px;
        }

        .project-card button {
            margin-top: auto;
        }

        .project-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

    .carousel-control-prev-icon,
    .carousel-control-next-icon {
        filter: invert(1);
    }

    .carousel-control-prev, .carousel-control-next {
        z-index: 1;
    }
</style>